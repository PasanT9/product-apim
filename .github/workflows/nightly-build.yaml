name: Nightly Build

on:
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:
    inputs:
      apimgtTag:
        description: "Override carbon-apimgt tag (leave empty for latest)"
        required: false
        default: ""
      kernelTag:
        description: "Override carbon-kernel tag (leave empty for latest)"
        required: false
        default: ""

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: nightly-bump-deps
  cancel-in-progress: true

jobs:

  bump-carbon-apimgt:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout product-apim
        uses: actions/checkout@v3

      - name: Resolve carbon-apimgt version
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          OVERRIDE: ${{ inputs.apimgtTag }}
        run: |
          OWNER="pasant9"
          REPO="carbon-apimgt"

          if [[ -n "$OVERRIDE" ]]; then
            TAG="$OVERRIDE"
            echo "Override apimgt tag: $TAG"
          else
            TAG=$(gh api "repos/$OWNER/$REPO/tags?per_page=1" -q '.[0].name')
          fi

          VERSION="${TAG#v}"

          echo "APIMGT_TAG=$TAG" >> $GITHUB_ENV
          echo "APIMGT_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Update apimgt version in all poms
        shell: bash
        run: |
          VERSION="$APIMGT_VERSION"

          FILES=(
            "api-control-plane/pom.xml"
            "gateway/pom.xml"
            "traffic-manager/pom.xml"
            "all-in-one-apim/pom.xml"
          )

          for f in "${FILES[@]}"; do
            sed -i "s#<carbon\.apimgt\.version>[^<]*</carbon\.apimgt\.version>#<carbon.apimgt.version>${VERSION}</carbon.apimgt.version>#g" "$f"
          done

          if git diff --quiet -- "${FILES[@]}"; then
            echo "No APIMGT bump needed"
            exit 0
          fi

      - name: Create/update PR (carbon-apimgt)
        uses: peter-evans/create-pull-request@v6
        with:
          branch: chore/bump-carbon-apimgt-nightly
          title: "Bump carbon-apimgt to ${{ env.APIMGT_VERSION }}"
          commit-message: "Bump carbon-apimgt to ${{ env.APIMGT_VERSION }}"
          body: |
            Automated carbon-apimgt bump.
            Tag: `${{ env.APIMGT_TAG }}`
            Version: `${{ env.APIMGT_VERSION }}`
          labels: dependency-bump
          
  bump-carbon-kernel:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout product-apim
        uses: actions/checkout@v3

      - name: Resolve carbon-kernel version (4.9.x only)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          OVERRIDE: ${{ inputs.kernelTag }}
        run: |
          OWNER="pasant9"
          REPO="carbon-kernel"

          is49() {
            [[ "$1" =~ ^4\.9\.[0-9]+.*$ ]]
          }

          if [[ -n "$OVERRIDE" ]]; then
            VERSION="${OVERRIDE#v}"
            if ! is49 "$VERSION"; then
              echo "Override tag must be 4.9.x"
              exit 1
            fi
            TAG="$OVERRIDE"
          else
            TAG=$(gh api "repos/$OWNER/$REPO/tags?per_page=100" \
              -q '[.[].name] | map(sub("^v";"")) | map(select(startswith("4.9."))) | .[0]')
            VERSION="$TAG"
            TAG="v$VERSION"
          fi

          echo "KERNEL_TAG=$TAG" >> $GITHUB_ENV
          echo "KERNEL_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Update kernel version in all poms
        shell: bash
        run: |
          VERSION="$KERNEL_VERSION"

          FILES=(
            "api-control-plane/pom.xml"
            "gateway/pom.xml"
            "traffic-manager/pom.xml"
            "all-in-one-apim/pom.xml"
          )

          for f in "${FILES[@]}"; do
            sed -i "s#<carbon\.kernel\.version>[^<]*</carbon\.kernel\.version>#<carbon.kernel.version>${VERSION}</carbon.kernel.version>#g" "$f"
          done

          if git diff --quiet -- "${FILES[@]}"; then
            echo "No KERNEL bump needed"
            exit 0
          fi

      - name: Create/update PR (carbon-kernel 4.9.x)
        uses: peter-evans/create-pull-request@v6
        with:
          branch: chore/bump-carbon-kernel-49-nightly
          title: "Bump carbon-kernel (4.9.x) to ${{ env.KERNEL_VERSION }}"
          commit-message: "Bump carbon-kernel (4.9.x) to ${{ env.KERNEL_VERSION }}"
          body: |
            Automated carbon-kernel (4.9.x) bump.
            Tag: `${{ env.KERNEL_TAG }}`
            Version: `${{ env.KERNEL_VERSION }}`
          labels: dependency-bump
